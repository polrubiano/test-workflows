name: Crear Labels e Issues desde JSON/Markdown

on:
  workflow_dispatch:

jobs:
  create-labels-and-issues:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v3

      - name: Crear Labels e Issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node -e '
            const fs = require("fs");
            const { execSync } = require("child_process");
            
            const data = JSON.parse(fs.readFileSync(".github/issues-template.json", "utf-8"));
            
            const labelMap = new Map();
            data.labels.forEach(label => {
              labelMap.set(label.name.toLowerCase(), label);
            });
            
            let issueMap = new Map();
            
            function readAndProcessTemplate(templatePath, placeholders) {
              let template = fs.readFileSync(templatePath, "utf-8");
              Object.keys(placeholders).forEach(key => {
                const regex = new RegExp(`{{${key}}}`, "g");
                template = template.replace(regex, placeholders[key]);
              });
                return template;
            }
            
            function createIssue(issue, parentId = "") {
              const labels = issue.labels || [];
              const validLabels = labels.filter(label => labelMap.has(label.toLowerCase())); 
              const templateType = labels.some(label => label.toLowerCase() === "feature") ? "feature" : "task";
              const templatePath = `.github/ISSUE_TEMPLATE/${templateType}.md`;
            
              const placeholders = {
                TITLE: issue.title,
                PARENT: parentId ? `- ${parentId}` : "",
                TASKS: issue.subissues ? issue.subissues.map(sub => `- ${sub.title}`).join("\n") : ""
              };
          
              const body = readAndProcessTemplate(templatePath, placeholders);
          
              const issueUrl = execSync(
                `gh issue create --title "${issue.title}" --body "${body}" ${
                  validLabels.length > 0 ? `--label "${validLabels.join(",")}"` : ""
                } ${issue.assignees ? "--assignee \"" + issue.assignees.join(",") + "\"" : ""}`,
                { encoding: "utf-8" }
              ).trim();
          
              issueMap.set(issue.title, issueUrl);
              return issueUrl;
            }
            
            function processIssues(issues, parentId = "") {
              for (const issue of issues) {
                const issueUrl = createIssue(issue, parentId);
                if (issue.subissues) {
                  processIssues(issue.subissues, issueUrl);
                }
              }
            }
            
            function createReferences(subissueTitles) {
              return subissueTitles
                .map(title => `- ${issueMap.get(title)}`)
                .join("\n");
            }
            
            function processParentIssues(issues) {
              issues.forEach(parent => {
                if (parent.subissues) {
                  const references = createReferences(parent.subissues.map(sub => sub.title));
                  const newBody = parent.body + `\n\n## References\n${references}`;
                  execSync(
                    `gh issue edit ${issueMap.get(parent.title)} --body "${newBody}"`,
                    { encoding: "utf-8" }
                  );
                }
              });
            }
            
            data.labels.forEach(label => {
              execSync(
                `gh label create "${label.name}" --description "${label.description}" --color "${label.color}" --force`,
                { stdio: "inherit" }
              );
            });
          
            processIssues(data.issues);
            processParentIssues(data.issues);
          '