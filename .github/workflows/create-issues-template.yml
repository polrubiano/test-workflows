name: Crear Labels e Issues desde JSON/Markdown

on:
  workflow_dispatch:

jobs:
  create-labels-and-issues:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v3

      - name: Crear Labels e Issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Leyendo el archivo JSON..."
          node -e '
            const fs = require("fs");
            const { execSync } = require("child_process");

            // Leer el JSON con etiquetas e issues
            const data = JSON.parse(fs.readFileSync("issues-template.json", "utf-8"));

            // Crear Labels en el repositorio
            console.log("Creando etiquetas...");
            data.labels.forEach(label => {
              console.log(`Creando etiqueta: ${label.name}`);
              execSync(
                `gh label create "${label.name}" --description "${label.description}" --color "${label.color}"`,
                { stdio: "inherit" }
              );
            });

            // FunciÃ³n para leer contenido Markdown
            function readMarkdown(filePath) {
              return fs.existsSync(filePath) ? fs.readFileSync(filePath, "utf-8") : "";
            }

            // Crear Issues y Subissues
            console.log("Creando issues...");
            function createIssue(issue) {
              const body = issue.bodyFile ? readMarkdown(issue.bodyFile) : (issue.body || "");
              console.log(`Creando issue: ${issue.title}`);
              const issueUrl = execSync(
                `gh issue create --title "${issue.title}" --body "${body}" ${issue.labels ? "--label " + issue.labels.join(",") : ""} ${issue.assignees ? "--assignee " + issue.assignees.join(",") : ""}`,
                { encoding: "utf-8" }
              ).trim();
              return issueUrl;
            }

            data.issues.forEach(issue => {
              const issueUrl = createIssue(issue);
              if (issue.subissues) {
                issue.subissues.forEach(subissue => {
                  subissue.body = `Subtarea de: ${issueUrl}\n\n` + (subissue.bodyFile ? readMarkdown(subissue.bodyFile) : (subissue.body || ""));
                  createIssue(subissue);
                });
              }
            });
          '